[manifest]
version = "1.1.3"
dump_lua = true
priority = 0


# Credits to Paperback for the patch!
[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = "if add and not G.GAME.banned_keys[v.key] then "
position = "after"
match_indent = true
payload = '''
    -- If the selected deck is the Kingdom deck and this key is Kingdom Hearts Joker, add copies of it
    -- to the pool, so that it is more common to get
    local kingdom = 
        (G.GAME.selected_back_key or {}).key == 'b_kh_kingdom'
        or G.GAME.selected_sleeve == 'sleeve_kh_kingdom'
        
    if kingdom and v.key:find('j_kh_') then
      for i = 1, 2 do
        _pool[#_pool + 1] = v.key
        _pool_size = _pool_size + 1
      end
    end
'''

# function Card:flip(), Credits to Bunco for the patch!
[[patches]]
[patches.pattern]
target = 'card.lua'
pattern = "self.facing='back'"
position = 'after'
match_indent = true
payload = '''

if self.config.center.key == 'j_kh_kairi' then
    self:flip()
    self:calculate_joker({flip = true})
end
'''

# Add context when a card retriggers
# Credit: Somethingcom515
[[patches]]
[patches.pattern]
target = '=[SMODS _ "src/utils.lua"]'
pattern = '''effect.message = effect.message or (not effect.remove_default_message and localize('k_again_ex'))'''
position = "after"
payload = '''
effect.extra = {func = function() SMODS.calculate_context({card_retriggered = true}) end}
'''
match_indent = true


# thank you cryptid for the following patches used for the Got it Memorised Challenge!

# Remove tags
[[patches]]
[patches.pattern]
target = "functions/UI_definitions.lua"
pattern = "if type == 'Small' then"
position = "at"
payload = "if type == 'Small' and not G.GAME.modifiers.no_skipping then"
match_indent = true

# Remove tags
[[patches]]
[patches.pattern]
target = "functions/UI_definitions.lua"
pattern = "elseif type == 'Big' then"
position = "at"
payload = "elseif type == 'Big' and not G.GAME.modifiers.no_skipping then"
match_indent = true

# Remove tags
[[patches]]
[patches.pattern]
target = "functions/UI_definitions.lua"
pattern = "elseif not run_info then"
position = "at"
payload = "elseif type == 'Boss' and not run_info then"
match_indent = true


# big blind bosses
[[patches]]
[patches.pattern]
target = "game.lua"
pattern = "self.GAME.round_resets.blind_choices.Boss = get_new_boss()"
position = "before"
payload = '''
if G.GAME.modifiers.kh_got_it_memorized then
    self.GAME.round_resets.blind_choices.Small = get_new_boss()
    self.GAME.round_resets.blind_choices.Big = get_new_boss()
else
    self.GAME.round_resets.blind_choices.Big = 'bl_big'
end
'''
match_indent = true


# big blind bosses
[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = "G.GAME.round_resets.blind_choices.Boss = get_new_boss()"
position = "before"
payload = '''
if G.GAME.modifiers.kh_got_it_memorized then
    G.GAME.round_resets.blind_choices.Small = get_new_boss()
    G.GAME.round_resets.blind_choices.Big = get_new_boss()
else
    G.GAME.round_resets.blind_choices.Big = 'bl_big'
end
'''
match_indent = true


# Small and Big Boss Blinds don't increase ante
[[patches]]
[patches.pattern]
target = "functions/state_events.lua"
pattern = "delay(0.4); SMODS.ante_end = true; ease_ante(1); SMODS.ante_end = nil; delay(0.4); check_for_unlock({type = 'ante_up', ante = G.GAME.round_resets.ante + 1})"
position = "at"
payload = '''
if G.GAME.blind_on_deck == "Boss" then
	delay(0.4); SMODS.ante_end = true; ease_ante(1); SMODS.ante_end = nil; delay(0.4); check_for_unlock({type = 'ante_up', ante = G.GAME.round_resets.ante + 1})
end
'''
match_indent = true
overwrite = true


# Smaller showdown blinds don't win
[[patches]]
[patches.pattern]
target = "functions/state_events.lua"
pattern = "if G.GAME.round_resets.ante == G.GAME.win_ante and G.GAME.blind:get_type() == 'Boss' then"
position = "at"
payload = "if G.GAME.round_resets.ante == G.GAME.win_ante and G.GAME.blind_on_deck == 'Boss' then"
match_indent = true


# Mark small blind as defeated
[[patches]]
[patches.pattern]
target = "functions/state_events.lua"
pattern = "if G.GAME.round_resets.blind == G.P_BLINDS.bl_small then"
position = "at"
payload = "if G.GAME.blind_on_deck == 'Small' then"
match_indent = true


# Mark big blind as defeated
[[patches]]
[patches.pattern]
target = "functions/state_events.lua"
pattern = "elseif G.GAME.round_resets.blind == G.P_BLINDS.bl_big then"
position = "at"
payload = "elseif G.GAME.blind_on_deck == 'Big' then"
match_indent = true



# Funky patch which fixes let him cook to make it so that when you create a copy of the joker it creates an entirely new card (prevents crashes)
[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = "local new_card = new_card or Card(other.T.x, other.T.y, G.CARD_W*(card_scale or 1), G.CARD_H*(card_scale or 1), G.P_CARDS.empty, G.P_CENTERS.c_base, {playing_card = playing_card, bypass_back = G.GAME.selected_back.pos})"
position = "before"
match_indent = true
payload = '''
if other.config and other.config.center and other.config.center.key == "j_kh_lethimcook" then
    -- Spawn a brand-new Joker using create_card
    local new_joker = create_card("Joker", G.jokers, nil, nil, false, nil, "j_kh_lethimcook")
    return new_joker
end
'''

# main menu stuff - credits to Maximus, Check them out!
[[patches]]
[patches.pattern]
target = "game.lua"
pattern = '''
if self.SPLASH_LOGO then self.SPLASH_LOGO:remove(); self.SPLASH_LOGO = nil end
'''
position = "after"
payload = '''
if self.SPLASH_KH_LOGO then self.SPLASH_KH_LOGO:remove(); self.SPLASH_KH_LOGO = nil end
'''
match_indent = true
times = 1

[[patches]]
[patches.pattern]
target = "game.lua"
pattern = '''
if G.SPLASH_LOGO then
    love.graphics.push()
    G.SPLASH_LOGO:translate_container()
    G.SPLASH_LOGO:draw()
    love.graphics.pop()
end
'''
position = "after"
payload = '''

if G.SPLASH_KH_LOGO then
    love.graphics.push()
    G.SPLASH_KH_LOGO:translate_container()

    if not G.SPLASH_KH_LOGO.states.drag.is then
        local scale_mod = 0.07 + 0.02*math.sin(1.8*G.TIMERS.REAL) + 0.00*math.sin((G.TIMERS.REAL - math.floor(G.TIMERS.REAL))*math.pi*14)*(1 - (G.TIMERS.REAL - math.floor(G.TIMERS.REAL)))^3
        local rotate_mod = 0.05*math.sin(1.219*G.TIMERS.REAL) + 0.00*math.sin((G.TIMERS.REAL)*math.pi*5)*(1 - (G.TIMERS.REAL - math.floor(G.TIMERS.REAL)))^2

        G.SPLASH_KH_LOGO:draw_shader('dissolve',0, nil, nil, G.SPLASH_KH_LOGO,scale_mod, rotate_mod,nil, 0.1 + 0.03*math.sin(1.8*G.TIMERS.REAL),nil, 0.6)
        G.SPLASH_KH_LOGO:draw_shader('dissolve', nil, nil, nil, G.SPLASH_KH_LOGO, scale_mod, rotate_mod)local scale_mod = 0.07 + 0.02*math.sin(1.8*G.TIMERS.REAL) + 0.00*math.sin((G.TIMERS.REAL - math.floor(G.TIMERS.REAL))*math.pi*14)*(1 - (G.TIMERS.REAL - math.floor(G.TIMERS.REAL)))^3
        local rotate_mod = 0.05*math.sin(1.219*G.TIMERS.REAL) + 0.00*math.sin((G.TIMERS.REAL)*math.pi*5)*(1 - (G.TIMERS.REAL - math.floor(G.TIMERS.REAL)))^2

        G.SPLASH_KH_LOGO:draw_shader('dissolve',0, nil, nil, G.SPLASH_KH_LOGO,scale_mod, rotate_mod,nil, 0.1 + 0.03*math.sin(1.8*G.TIMERS.REAL),nil, 0.6)
        G.SPLASH_KH_LOGO:draw_shader('dissolve', nil, nil, nil, G.SPLASH_KH_LOGO, scale_mod, rotate_mod)
    end

    add_to_drawhash(G.SPLASH_KH_LOGO)

    love.graphics.pop()
end
'''
match_indent = true
times = 1

# Game Variables
[[patches]] #G.GAME 
[patches.pattern]
target = 'game.lua'
pattern = '''
unused_discards = 0,'''
position = 'after'
match_indent = true 
payload = '''
kh = {
    moogle_shop = false,
    moogle_skip = false,
    luxord_sold = false,
    luxord_destroyed = false,
},
'''

[[patches]]
[patches.pattern]
target = "functions/UI_definitions.lua"
pattern = "extras = create_UIBox_blind_tag(type, run_info)"
position = "after"
payload = '''
    -- Add second skip option
    if extras and not run_info and G.GAME.moogle_skip then
        G.GAME.round_resets.blind_tags = G.GAME.round_resets.blind_tags or {}
        local alt_key = type..'_alt'
        if not G.GAME.round_resets.blind_tags[alt_key] then
            G.GAME.round_resets.blind_tags[alt_key] = get_next_tag_key()
        end
        
        -- Create second tag UI
        local _tag = Tag(G.GAME.round_resets.blind_tags[alt_key], nil, type)
        local _tag_ui, _tag_sprite = _tag:generate_UI()
        _tag_sprite.states.collide.can = true
        
        local skip2 = {n=G.UIT.R, config={id = 'tag_container_alt', ref_table = _tag, align = "cm"}, nodes={
            {n=G.UIT.R, config={align = 'tm', minh = 0.1}, nodes={
            }},
            {n=G.UIT.R, config={id = 'tag_'..alt_key, align = "cm", r = 0.1, padding = 0.1, minw = 1, can_collide = true, ref_table = _tag_sprite}, nodes={
                {n=G.UIT.C, config={id = 'tag_desc_alt', align = "cm", minh = 1}, nodes={
                    _tag_ui
                }},
                {n=G.UIT.C, config={align = "cm", colour = G.C.RED, minh = 0.6, minw = 2, maxw = 2, padding = 0.07, r = 0.1, shadow = true, hover = true, one_press = true, button = 'skip_blind_alt', func = 'hover_tag_proxy', ref_table = _tag}, nodes={
                    {n=G.UIT.T, config={text = localize('b_skip_blind'), scale = 0.4, colour = G.C.WHITE}}
                }}
            }}
        }}
        
        -- Wrap both skip options
        extras = {
            n = G.UIT.R, 
            config = {align = "cm", padding = 0.1}, 
            nodes = {
                extras,
                skip2
            }
        }
    end'''
match_indent = true

[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = '''          local _tag = e.UIBox:get_UIE_by_ID('tag_'..e.config.id)
          local _tag_container = e.UIBox:get_UIE_by_ID('tag_container')'''
position = "after"
payload = '''          local _tag_alt = e.UIBox:get_UIE_by_ID('tag_'..e.config.id..'_alt')
          local _tag_container_alt = e.UIBox:get_UIE_by_ID('tag_container_alt')'''
match_indent = true

[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = '''          if _tag_container and not G.SETTINGS.tutorial_complete and not G.SETTINGS.tutorial_progress.completed_parts['shop_1'] then _tag_container.states.visible = false
          elseif _tag_container then  _tag_container.states.visible = true end'''
position = "at"
payload = '''         
          for _, container in ipairs({_tag_container, _tag_container_alt}) do
            if container and not G.SETTINGS.tutorial_complete and not G.SETTINGS.tutorial_progress.completed_parts['shop_1'] then 
              container.states.visible = false
            elseif container then  
              container.states.visible = true 
            end
          end'''
match_indent = true

[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = '''            if _tag and _tag_container then 
              _tag_container.children[2].config.draw_after = false
              _tag_container.children[2].config.colour = G.C.BLACK
              _tag.children[2].config.button = 'skip_blind'
              _tag.config.outline_colour = adjust_alpha(G.C.BLUE, 0.5)
              _tag.children[2].config.hover = true
              _tag.children[2].config.colour = G.C.RED
              _tag.children[2].children[1].config.colour = G.C.UI.TEXT_LIGHT
              local _sprite = _tag.config.ref_table
              _sprite.config.force_focus = nil
            end'''
position = "at"
payload = '''
            for i, _tag_obj in ipairs({_tag, _tag_alt}) do
              local _container = i == 1 and _tag_container or _tag_container_alt
              if _tag_obj and _container then 
                _container.children[2].config.draw_after = false
                _container.children[2].config.colour = G.C.BLACK
                _tag_obj.children[2].config.button = i == 1 and 'skip_blind' or 'skip_blind_alt'
                _tag_obj.config.outline_colour = adjust_alpha(i == 1 and G.C.BLUE or G.C.RED, 0.5)
                _tag_obj.children[2].config.hover = true
                _tag_obj.children[2].config.colour = i == 1 and G.C.RED or G.C.RED
                _tag_obj.children[2].children[1].config.colour = G.C.UI.TEXT_LIGHT
                local _sprite = _tag_obj.config.ref_table
                _sprite.config.force_focus = nil
              end
            end'''
match_indent = true

[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = ''' if _tag and _tag_container then 
              if G.GAME.round_resets.blind_states[e.config.id] == 'Skipped' or
                 G.GAME.round_resets.blind_states[e.config.id] == 'Defeated' then
                _tag_container.children[2]:set_role({xy_bond = 'Weak'})
                _tag_container.children[2]:align(0, 10)
                _tag_container.children[1]:set_role({xy_bond = 'Weak'})
                _tag_container.children[1]:align(0, 10)
              end
              if G.GAME.round_resets.blind_states[e.config.id] == 'Skipped' then
                _blind_choice.children.alert = UIBox{
                  definition = create_UIBox_card_alert({text_rot = -0.35, no_bg = true,text = localize('k_skipped_cap'), bump_amount = 1, scale = 0.9, maxw = 3.4}),
                  config = {
                    align="tmi",
                    offset = {x = 0, y = 2.2},
                    major = _blind_choice, parent = _blind_choice}
                }
              end
              _tag.children[2].config.button = nil
              _tag.config.outline_colour = G.C.UI.BACKGROUND_INACTIVE
              _tag.children[2].config.hover = false
              _tag.children[2].config.colour = G.C.UI.BACKGROUND_INACTIVE
              _tag.children[2].children[1].config.colour = G.C.UI.TEXT_INACTIVE
              local _sprite = _tag.config.ref_table
              _sprite.config.force_focus = true
            end'''
position = "before"
payload = '''
            for i, _tag_obj in ipairs({_tag, _tag_alt}) do
              local _container = i == 1 and _tag_container or _tag_container_alt
            end'''
match_indent = true


[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = ''' if _tag and _tag_container then 
              if G.GAME.round_resets.blind_states[e.config.id] == 'Skipped' or
                 G.GAME.round_resets.blind_states[e.config.id] == 'Defeated' then
                _tag_container.children[2]:set_role({xy_bond = 'Weak'})
                _tag_container.children[2]:align(0, 10)
                _tag_container.children[1]:set_role({xy_bond = 'Weak'})
                _tag_container.children[1]:align(0, 10)
              end
              if G.GAME.round_resets.blind_states[e.config.id] == 'Skipped' then
                _blind_choice.children.alert = UIBox{
                  definition = create_UIBox_card_alert({text_rot = -0.35, no_bg = true,text = localize('k_skipped_cap'), bump_amount = 1, scale = 0.9, maxw = 3.4}),
                  config = {
                    align="tmi",
                    offset = {x = 0, y = 2.2},
                    major = _blind_choice, parent = _blind_choice}
                }
              end
              _tag.children[2].config.button = nil
              _tag.config.outline_colour = G.C.UI.BACKGROUND_INACTIVE
              _tag.children[2].config.hover = false
              _tag.children[2].config.colour = G.C.UI.BACKGROUND_INACTIVE
              _tag.children[2].children[1].config.colour = G.C.UI.TEXT_INACTIVE
              local _sprite = _tag.config.ref_table
              _sprite.config.force_focus = true
            end'''
position = "at"
payload = '''
            for i, _tag_obj in ipairs({_tag, _tag_alt}) do
              local _container = i == 1 and _tag_container or _tag_container_alt
              if _tag_obj and _container then 
                if G.GAME.round_resets.blind_states[e.config.id] == 'Skipped' then
                  _blind_choice.children.alert = UIBox{
                    definition = create_UIBox_card_alert({text_rot = -0.35, no_bg = true,text = localize('k_skipped_cap'), bump_amount = 1, scale = 0.9, maxw = 3.4}),
                    config = {
                      align="tmi",
                      offset = {x = 0, y = 2.2},
                      major = _blind_choice, parent = _blind_choice}
                  }
                end
                if G.GAME.round_resets.blind_states[e.config.id] == 'Skipped' or
                   G.GAME.round_resets.blind_states[e.config.id] == 'Defeated' then
                  _container.children[2]:set_role({xy_bond = 'Weak'})
                  _container.children[2]:align(0, 10)
                  _container.children[1]:set_role({xy_bond = 'Weak'})
                  _container.children[1]:align(0, 10)
                end
                
                _tag_obj.children[2].config.button = nil
                _tag_obj.config.outline_colour = G.C.UI.BACKGROUND_INACTIVE
                _tag_obj.children[2].config.hover = false
                _tag_obj.children[2].config.colour = G.C.UI.BACKGROUND_INACTIVE
                _tag_obj.children[2].children[1].config.colour = G.C.UI.TEXT_INACTIVE
                local _sprite = _tag_obj.config.ref_table
                _sprite.config.force_focus = true
              end
            end'''
match_indent = true


